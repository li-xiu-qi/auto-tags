# 标签生成器功能设计

## 概述

Obsidian Auto Tags 插件的标签生成器（Tag Generator）功能允许用户为文档自动生成标签。该功能支持参考工作区中已有的标签来生成新标签，并可选择使用 embedding 技术进行智能过滤，从而确保生成的标签与库中的现有标签保持一致性和相关性。

## 功能特性

- **AI 驱动生成**：使用 LLM API 基于文档内容生成标签。
- **智能标签过滤**：支持 embedding 过滤和容量限制，确保标签相关性和提示词长度控制。
- **参考现有标签**：在生成新标签时，参考工作区中其他文档的标签，避免重复或不一致。
- **增量更新**：将新生成的标签添加到文档的现有标签中，而不是替换。
- **多语言支持**：支持英文和中文提示词及容量计算。
- **容量控制**：基于字数/单词数限制标签容量，避免超出模型 token 限制。
- **错误处理**：提供详细的错误提示，包括网络、API 密钥等问题。

## 实现原理

### 核心流程

1. **获取现有标签**：从当前文档的 frontmatter 中解析现有标签。
2. **收集工作区标签**：扫描工作区中所有 Markdown 文件，收集所有已使用的标签。
3. **过滤标签**：从工作区标签中移除当前文档的现有标签，避免重复。
4. **智能选择标签**：根据配置选择标签子集（embedding 过滤或默认排序），并基于容量限制。
5. **构建提示词**：将选择的标签列表嵌入到 AI 提示词中，作为生成新标签的参考。
6. **调用 AI API**：使用 LLM API 生成标签，响应包含现有标签和新标签。
7. **更新文档**：将新生成的标签添加到文档的 frontmatter 中。

### 关键函数

#### `tagText` (在 `tag-generator.ts` 中)

这是主要入口函数，负责为单个文档生成标签：

- 解析文档内容，提取去除 frontmatter 后的纯文本。
- 获取现有标签。
- 调用 `generateTags` 生成新标签。
- 更新文档的 frontmatter。

#### `generateTags` (在 `ai-generation.ts` 中)

负责与 AI API 交互：

- 获取工作区标签字符串。
- 构建包含系统提示、示例和用户消息的消息数组。
- 调用 LLM API。
- 解析响应，返回生成的标签数组。

#### `getTagsString` (在 `ai-generation.ts` 中)

生成用于提示词的标签字符串：

- 获取工作区所有标签。
- 过滤掉当前文档的现有标签。
- 根据配置选择候选标签（embedding 过滤或字母排序）。
- 基于容量限制选择最终标签。
- 格式化为字符串形式（每行一个标签）。

#### `getVaultTags` (在 `tag-utils.ts` 中)

收集工作区中所有唯一标签：

- 遍历所有 Markdown 文件。
- 使用 Obsidian 的 `getAllTags` 函数提取标签。
- 使用 Set 确保唯一性。

#### `selectTagsByCapacity` (在 `ai-generation.ts` 中)

基于容量限制选择标签：

- 根据语言设置计算每个标签的容量单位（中文：字符数，英文：单词数）。
- 累积标签直到达到最大容量限制。
- 确保提示词不会超出模型的 token 限制。

## 智能标签选择

### Embedding 过滤

当启用 embedding 开关并配置了 embedding API 时：

1. 使用文档内容和候选标签生成 embeddings。
2. 计算文档内容与每个标签的相似度。
3. 选择最相关的标签作为候选集。
4. 应用容量限制选择最终标签。

### 默认选择

当未配置 embedding 时：

- 按字母顺序排序候选标签。
- 应用容量限制选择最终标签。

### 容量计算

- **中文模式**：每个标签按字符数计算，建议最大容量 1000 字符。
- **英文模式**：每个标签按单词数计算，建议最大容量 3000 单词。
- **累积策略**：按顺序添加标签直到达到容量上限。

## 提示词设计

提示词分为系统提示和用户消息：

- **系统提示**：定义 AI 的角色和任务。
- **示例**：提供生成标签的示例，包括输入标签和文档，输出标签。
- **用户消息**：包含选择的标签列表和当前文档内容。

通过在用户消息中包含精心选择的标签，AI 可以学习库的标签风格和主题，确保生成的新标签与之匹配。

## 配置选项

- **LLM 设置**：API Key、Base URL、模型选择。
- **Embedding 设置**：API Key、Base URL、模型选择（可选，用于智能过滤）。
- **Embedding 开关**：是否启用 embedding 过滤功能。
- **语言设置**：英文或中文，影响提示词选择和容量计算方式。
- **容量设置**：最大标签容量（字数/单词数），默认 3000（英文）或 1000（中文）。
- **标签格式**：是否强制小写标签。

## 错误处理

提供针对不同错误的特定提示：

- 网络连接问题。
- API 密钥无效。
- Embedding 服务失败（自动回退到默认选择）。
- 超时或服务器错误。

## 文件结构

```text
src/
├── main.ts                 # 插件主入口
├── settings.ts             # 设置接口定义
├── settings-tab.ts         # 设置页面
├── tag-utils.ts           # 标签工具函数
├── ai-generation.ts       # AI 生成相关函数
├── prompts/               # 提示词模板
│   ├── index.ts
│   ├── en/                # 英文提示词
│   └── zh/                # 中文提示词
└── features/
    └── tag-generator.ts   # 标签生成器核心逻辑
```

## 扩展性

该设计允许轻松扩展：

- 添加更多语言支持。
- 集成其他 AI 服务和 embedding 提供商。
- 自定义提示词模板和容量计算策略。
- 支持更多标签元数据和过滤条件。

## 总结

标签生成器通过结合 AI 生成能力和智能标签过滤技术，实现上下文感知的标签生成。容量控制和 embedding 过滤确保了生成过程的高效性和相关性，帮助用户维护一致的标签系统，提高文档组织效率。
